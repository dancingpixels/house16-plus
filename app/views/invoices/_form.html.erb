<%= form_with model: @invoice, local: true do |form_builder| %>
  <!-- Line Items Stimulus Controller -->
  <div data-controller="line-items">
    <!-- Existing Line Items -->
    <div data-line-items-target="container">
      <%= form_builder.fields_for :line_items do |lf| %>
        <%= render 'line_item_fields', f: lf %>
      <% end %>
    </div>

    <!-- Hidden Template for New Line Items -->
    <template data-line-items-target="template">
  <%= capture do %>
    <%= form_builder.fields_for :line_items, LineItem.new, child_index: "NEW_RECORD" do |lf| %>
      <%= render 'line_item_fields', f: lf %>
    <% end %>
  <% end %>
</template>


    <!-- Add Line Item Button -->
    <button type="button" class="btn btn-outline-primary mt-2" data-action="click->line-items#add">
      âž• Add Line Item
    </button>

    <!-- Invoice Total (Live Display) -->
    <div class="mt-4">
      <label class="form-label">Invoice Total:</label>
      <div class="form-control-plaintext fw-bold" data-line-items-target="invoiceTotal">0.00</div>
    </div>
  </div>

  <!-- Submit -->
  <div class="mt-4">
    <%= form_builder.submit "Save Invoice", class: "btn btn-primary" %>
  </div>
<% end %>
